# Job for running smoke tests on Chromium and generating Allure report
name: Playwright Tests  # Name of the GitHub Actions workflow

on:
  push:
    branches: [ main ]  # Trigger workflow when code is pushed to the main branch
  pull_request:
    branches: [ main ]  # Trigger workflow when a pull request targets the main branch

jobs:
  playwright-tests:  # First job: runs Playwright tests
    runs-on: ubuntu-latest  # Use the latest Ubuntu environment
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Check out the repository code to the runner

      - name: Setup Node.js
        uses: actions/setup-node@v4  # Set up Node.js environment
        with:
          node-version: 18  # Specify Node.js version 18

      - name: Install dependencies
        run: npm install  # Install Node.js dependencies from package.json

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps  # Install Playwright browsers and dependencies

      - name: Run all tests
        run: npx playwright test --reporter=line,allure-playwright  
        # Run Playwright tests with line reporter and Allure reporter

      - name: Upload Allure results
        if: always()  # Run this step even if previous steps fail
        uses: actions/upload-artifact@v4  # Upload files as GitHub Actions artifacts
        with:
          name: allure-results  # Name of the artifact
          path: allure-results  # Path to upload
          if-no-files-found: warn  # Warn if no files are found, donâ€™t fail the job

  generate-allure-report:  # Second job: generate Allure report
    needs: playwright-tests  # Run this job after playwright-tests job completes
    if: always()  # Run even if previous job failed
    runs-on: ubuntu-latest  # Use Ubuntu environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Check out repository code

      - name: Setup Node.js
        uses: actions/setup-node@v4  # Set up Node.js
        with:
          node-version: 18  # Use Node.js version 18

      - name: Install Allure CLI
        run: npm install -g allure-commandline  # Install Allure command line tool globally

      - name: Download Allure results
        uses: actions/download-artifact@v4  # Download artifact from previous job
        with:
          name: allure-results  # Name of artifact to download
          path: allure-results  # Destination path on runner

      - name: Generate Allure report
        run: allure generate allure-results --clean -o allure-report  
        # Generate Allure HTML report in 'allure-report' folder, cleaning previous report

      - name: Upload final Allure report
        uses: actions/upload-artifact@v4  # Upload final Allure report as artifact
        with:
          name: allure-report-final  # Artifact name
          path: allure-report  # Path to the generated report

#

# # Job for running Playwright tests in parallel across 4 shards and generating a merged Allure report
# name: Playwright Tests

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   playwright-tests:
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         shard: [1, 2, 3, 4]

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install dependencies
#         run: npm install

#       - name: Install Playwright Browsers
#         run: npx playwright install --with-deps

#       - name: Run Playwright tests (Shard ${{ matrix.shard }})
#         run: npx playwright test --shard=${{ matrix.shard }}/4 --reporter=line,allure-playwright

#       - name: Upload Allure results (Shard ${{ matrix.shard }})
#         uses: actions/upload-artifact@v4
#         with:
#           name: allure-results-shard-${{ matrix.shard }}
#           path: allure-results

#   merge-allure-results:
#     needs: playwright-tests
#     if: always()
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: Install Allure CLI
#         run: npm install -g allure-commandline

#       - name: Download all Allure results
#         uses: actions/download-artifact@v4
#         with:
#           path: allure-results

#       - name: Merge Allure results
#         run: |
#           mkdir merged-results
#           find allure-results -type f -exec cp {} merged-results \;

#       - name: Generate final Allure report
#         run: allure generate merged-results --clean -o allure-report

#       - name: Upload final Allure report
#         uses: actions/upload-artifact@v4
#         with:
#           name: allure-report-final
#           path: allure-report

# After raising a PR, the pipeline runs successfully and generates the merged Allure report artifact.
# Download the merged Allure artifact from GitHub Actions, unzip it, open the folder, type cmd in the address bar and press Enter.
# Run `npx serve`, copy the generated localhost URL, and open it in your browser to view the Allure report.
